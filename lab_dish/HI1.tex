\documentclass[psfig,preprint]{aastex}
\usepackage{amsmath}
\usepackage[top=1in, bottom=1in, left=1in, right=1in]{geometry}
%\usepackage{natbib}
%\usepackage{natbibspacing}
\usepackage{enumitem}
\usepackage{url}
\setlist[itemize]{noitemsep, topsep=0pt}
\setlist[enumerate]{noitemsep, topsep=0pt}
%\setlength{\bibspacing}{0pt}
\setlength{\parskip}{0pt}
\setlength{\parsep}{0pt}
\setlength{\headsep}{6pt}
\setlength{\topskip}{0pt}
\setlength{\topmargin}{0pt}
\setlength{\topsep}{6pt}
\setlength{\partopsep}{0pt}
\setlength{\footnotesep}{8pt}

%\documentstyle[11pt,psfig,aaspp4]{article}

\def\simlt{\lower.5ex\hbox{$\; \buildrel < \over \sim \;$}}
\def\simgt{\lower.5ex\hbox{$\; \buildrel > \over \sim \;$}}

%\usepackage{graphicx}
%\usepackage[verbose]{wrapfig}
\begin{document}
\tolerance=10000

\title{LAB 4: Mapping the Galactic HI Line}

\tableofcontents


\section{Introduction}

\noindent
Diffuse atomic gas permeates all corners of interstellar space.
On the largest scales, its distribution reveals a lot about Galactic
structure and dynamics. On smaller scales, its morphology is dominated
by shocks from energetic stellar winds and supernovae. On still smaller
scales, magnetic fields, pressure differences, and thermal instability
shape the gas into thin filaments and sheets. On still smaller scales,
the densities get large from self-gravitation; the gas turns molecular
and stars form. 
The dense regions where Star formation occurs occupy a
small fraction of the interstellar volume. In contrast, the atomic gas
(HI) resides in less-dense regions that occupy large fractions of
interstellar space and you see Galactic HI wherever you point the
telescope. 

For this lab, we outline several projects to map interesting structures
in HI using our 4.5-m diameter Leuschner dish. The HI projects
fall into two categories. One explores large-scale Galactic structure
and dynamics by obtaining HI spectra along great circles, presenting the
data as position-velocity images, and interpreting those maps as
discussed below. The other category maps specific interstellar
structures (e.g., expanding shells produced by multi-supernovae) by
sampling a grid of spectra over a large area, presenting the data as
grey-scale images of velocity-integrated line intensity (i.e., antenna
temperature $T_A$) or as images in which image brightness indicates
velocity-integrated $T_A$ and color indicates velocity.

We'd like each group to pick a single project and carry it through to
completion by the time the lab reports are due, which is the last day of
class. All of the HI projects involve making maps and
images. One of the features of this lab is to learn about image
processing and using colors in images.

For the great-circle projects (\S \ref{galacticplane} and \S
\ref{galacticpoles}), we gain large angular scale information
in the sky by observing on great circles. Getting nice results
requires data over the largest portions of the great circles you can
get. For a full 360-degree circle, that's 180 pointings at $2^\circ$
spacings.  Mostly, though, we can't cover a full great circle because
some of the circle lies too far south, so we do as much as we can. 

\section{Goals and Instructions for Your Report}

\noindent
The goals of this lab consist of some collection of the following,
depending on the project chosen:

\begin{itemize}

  \item Perform a large-scale observing survey project balancing
    considerations of telescope time, integration time, sky coverage,
    data reduction, report writing, and personal time commitment versus
    research goals and quality of results and their presentation.

\item Use the collected data to infer astrophysical phenomenae or
  quantities such as the properties of supernova-driven interstellar
  supershells and the Galaxy.

\item Present data and/or using greyscale and/or color images.

\item Learn about using colors in computer graphics including plots and
  images. 

\item Learn about problems in using color for presentations,
  specifically contrast issues and colorblindness.

\end{itemize}


\section{Schedule}

\noindent
The end of the semester approaches. Here's our
schedule.

\begin{enumerate}

\item Week 1: Pick a group project. Figure out the RA and
  Dec boundaries of your object, when the object is up, and how you
  sample the area with telescope pointings. Coordinate with other groups
  to figure out how you can share telescope time.
Devise a scheme for scheduling observations of all the points in your
map.  Begin the process of obtaining and reducing your map data. 

Obtain some frequency-switched test spectra, in
particular at our canonical comparison position at Galactic coordinates
$(\ell, b) = (120^\circ, 0^\circ)$.  We will compare the spectra of all
groups in class the second week, and if your group doesn't have a
spectrum to show this will be considered poor form.

\item Week 2: Get as much data as you can. Reduce the data.  Decide what
  projection you will use to present your maps; create the map plane and
  populate it to the extent possible with the data you've obtained.  You
  won't have all of your data, but begin the map-making process anyway
  (\S \ref{datadisplay}); this process begins with making a data cube.

\item Week 3: Get the rest of your data. Figure out
  how you want to present the data as images. Make some first-try
  images. 

\item Week 4: Finalize data. Make final images. Write
report. Report is due the last day of class.

\end{enumerate}

\section{Software for Controlling the Leuschner Telescope}

\noindent
At this point in the semeser, we assume you are familiar with
the standard software used in this class. The major difference
for this lab is that, instead of connecting to the {\tt ugastro}
subnet on campus, we must log in to a computer at the  remote 
Leuschner observatory and use screen to create a persistent
session that you can use to conduct your observations, even
if your {\tt ssh} connection gets broken.

\subsection {Connecting to the {\it heiles} Computer at Leuschner}

\noindent
Use {\tt ssh} to connect to Leuschner:
\begin{verbatim}
   ssh -XY radiolab@leuschner.berkeley.edu -p 31
\end{verbatim}
\noindent
Use the password we give you in class. The {\tt -XY} flag is optional; it forwards windows displays across the network so that you can plot
things on {\it heiles} and see the display on your local computer.
Unfortunately, this is usually very slow, so use this feature sparingly.
The {\tt -p 31} flag forwards {\tt ssh} traffic over a non-standard port
for security reasons. You'll need to use this port also when you copy
your data off of {\it heiles} to your local computer (or the ugastro
computers, if you are using them for data analysis):
\begin{verbatim}
    $ scp -P 31 radiolab@leuschner.berkeley.edu:path/to/file .
\end{verbatim}
\noindent
Note that {\tt scp} inexplicably uses a capital P where {\tt ssh} uses
lowercase.

All external users use the {\tt radiolab} account. You don't
want a subdirectory that contains files of other users, so immediately
after logging in create a subdirectory for yourself and do all of your
work there. For example, if your group is named DREAMTEAM: 
\begin{verbatim}
   radiolab@heiles:~> mkdir dreamteam
   radiolab@heiles:~> cd dreamteam
   radiolab@heiles:~/dreamteam> 
\end{verbatim}
The prompt tells you what subdirectory you're in; if in doubt, type {\tt
  pwd}. All of the canonical editors\footnote{When using {\tt emacs}, using the
  {\tt -nw} option will eliminate latency and delays, and your
  associated frustrations.} and Python/IPython are available to you, just as on the
{\tt ugastro} network.

\subsection {Using \texttt{screen} at Leuschner}

\noindent
For observing sessions that run automatically for long periods of
time, we will use \texttt{screen} to serve up a remote desktop. \texttt{screen} is a command that allows us to maintain a persistent session on a remote machine even when everyone is logged out. If everyone uses the same \texttt{screen} session, we avoid having more than one group observing at a time. We have set up a \texttt{screen} window on the heiles computer at Leuschner.  

To attach to this window, on heiles run 
\begin{verbatim}
    screen -r
\end{verbatim} 
(``r'' for ``reattach'') on heiles. This connects you to the existing session and command-line environment. Please remember to do this as soon as you log in! It can be easy to forget to go into \texttt{screen} before running your scripts as you usually would.

While you're in a screen session, all \texttt{screen} commands begin with \texttt{Ctrl-a}. To detach from the window and return to your login environment, run
\begin{verbatim}
    Ctrl-a d
\end{verbatim}. 
Before you log out of heiles, it's best to first detach the screen window before exiting -- otherwise, you may close the entire screen session and accidentally abort running programs.

Lastly, to check whether you are in \texttt{screen} or not, run
\begin{verbatim}
    screen -ls
\end{verbatim}
This will display any session that exist and tell you whether you are ``attached'' or ``detached'' to any of them!

Those commands should be sufficient for this lab, but \texttt{screen} is a very useful tool in general. If you're working on a remote machine and would like to run long programs without staying logged in, you can just type in  \texttt{screen} and it will start the program. You can also create a new window within the \texttt{screen} session by running \texttt{Ctrl-a c} (for ``create''). Once there are multiple windows, you can do \texttt{Ctrl-a n} (for ``next'') to cycle between them. Finally, if you want to close a window, you can do \texttt{Ctrl-a k} (for ``kill''). And as always, to bring up the full documentation, just do \texttt{man screen} at the command line.

%\subsection {Using VNC at the heiles computer at Leuschner}
%For observing sessions that run automatically for long periods of
%time, we will use VNC to serve up a remote desktop.
%If everyone uses the same VNC Leuschner window, we
%avoid having more than one group observing at a time. We have set
%up a VNC server on the heiles computer at Leuschner.  All network traffic
%between computers happens with specified port numbers; ports give 
%programs running on a computer their own channel for communicating without
%getting traffic from other programs.  The VNC
%server is usually on port 5901.  (Other famous ports include 22 for {\tt ssh} and 80 for web servers---the internet).
%
%So we have a VNC server communicating on a port (5901) of a remote computer (heiles).
%We need to access that server from a VNC client running on a local machine.
%To do this, we first need to establish a tunnel between a port on our local machine
%and {\tt heiles:5901}.  This is done with {\tt ssh} from the local machine:
%\begin{verbatim}
%    ssh -L 59XX:127.0.0.1:5901 -p 31 -N -f radiolab@leuschner.berkeley.edu
%\end{verbatim}
%\noindent It will require a password; use the password for the {\tt
%  radiolab} account given in class. Here {\tt XX} is a number of your
%own choosing; it refers to a port on your local machine. If you get the error
%{\tt bind: Address already in use}, then choose a different
%number and try again. Once you find a number that works, use it in
%subsequent connections. {\it As long as this {\tt ssh} command is active, it does not need to be re-run}.
%
%Having done that first step, on all subsequent occasions access the
%Leuschner/heiles VNC session with the command
%\begin{verbatim}
%   vncviewer -shared localhost::59XX
%\end{verbatim}
%\noindent It will require a VNC password---the password we tell you in class
%for the VNC server we started.  Leuschner's VNC window should pop
%up on your screen and you can access and create terminals on this
%window in the usual way. The function key F8 gives a short menu of
%available actions, such as quitting the VNC viewer. Using the {\tt
%  -shared} option allows multiple users to access the VNC window
%simultaneously. For example, if you are in the 5th floor lab and begin
%observing, you can leave your VNC session running, go home,
%and access the same VNC window from there. 

\subsection{Python Procedures for Controlling the Dish}

\noindent
The {\tt ugradio.leusch} module provides an interface for controlling
the Leuschner dish.  In particular, the {\tt LeuschTelescope} class should
look familiar to you; it is basically the same as the {\tt Interferometer}
class you used in the previous lab.

\begin{enumerate}
\item {\tt LeuschTelescope.get\_pointing()} returns the current (alt,az) of the dish, in degrees.
\item {\tt LeuschTelescop.point(alt,az)} moves the telescope to a specified alt, az in degrees.
%\item {\tt follow} tracks a given (ra,dec), sun, or moon and can write a
%  file containing relevant pointing data.
\item {\tt LeuschTelescope.maint()} moves the telescope to maintenance position.
\item {\tt LeuschTelescope.stow()} moves the telescope to stow position.
\end{enumerate}

\noindent
If you find you need the coordinates of the Leuschner Educational Observatory, they are stored in
{\tt ugradio.leo}.

\subsection{Python Procedures for Taking Data}

\noindent
The Leuschner dish has a noise diode at the front that you can turn on/off for
calibration purposes. It is slightly polarized, so it increments 
polarization 0 by 79 K and polarization 1 by 58 K.
\begin{enumerate}
\item {\tt ugradio.leusch.LeuschNoise()} instantiates an interface to the noise diode (it's controlled
by a Raspberry Pi).
\item {\tt LeuschNoise.on()} turns the noise source on.
\item {\tt LeuschNoise.off()} turns the noise source off.
\end{enumerate}

We also have an LO that you can shift around for calibration purposes.
You can control it remotely with {\it ugradio.agilent}. 
\begin{enumerate}
\item {\tt ugradio.agilent.SynthClient()} instantiates an interface to the LO
\item {\tt SynthClient.set\_frequency} changes the LO frequency.
\end{enumerate}

Next, we need to read data from the spectrometer attached to the Leuschner dish.  This
spectrometer is controlled by the {\tt leuschner} module outside of {\tt ugradio}. Unfortunately, this module is deeply incompatible with Python 3.
As a work-around, we made a {\tt ugradio.leusch.Spectrometer} object that
interacts with the Python 2 interface via the command line:
\begin{enumerate}
\item {\tt ugradio.leusch.Spectrometer()} instantiates an interface to the spectrometer
at the default IP address.
\item {\tt Spectrometer.int\_time} tells you how long each spectrum is integrated for.
\item {\tt Spectrometer.read\_spec('out.fits', N, (ra,dec), 'eq')} will read N spectra and
store the output in a FITS file, writing the ra/dec coordinates into the header of the file.  Note that
this does {\bf not} point the telescope; it just documents where it is pointed in the file.  You
could also provide {\it read\_spec('out.fits, N, (glat,glon), 'ga')} to write galactic coordinates
into the FITS header, if you'd like.
\item {\tt Spectrometer.check\_connected()} allows you to check that you are talking to the spectrometer to take data.
\end{enumerate}

Once you have a saved FITS file (which are a standard file format in astronomy), you need to get your data out of it.  For this,
we use the standard module {\tt astropy.io.fits}, typically imported as
{\tt from astropy.io import fits}.
\begin{enumerate}
\item {\tt f = fits.open('out.fits')} opens your file and returns you a handle to it.
\item {\tt f[0].header} holds lots of metadata about your observation.  Your can {\tt print f[0].header},
or you can convert it to a dictionary with {\tt dict(f[0].header}.
\item {\tt f[1].data['auto0\_real']} returns the first spectrum for the first polarization, {\tt f[1].data['auto1\_real']} returns the first spectrum for the second polarization, and {\tt f[N].data['auto0\_real']} returns the N$^{\rm th}$
spectrum for the first polarization.
\end{enumerate}

%\begin{enumerate}
%\item {\tt getspect} sets the LO\ and the noise diode, then averages a
%  specified number of spectra from the ROACH box and optionally plots or
%  saves the result in an IDL save file, which contain ancillary info
%  such as Julian day. ra, dec, etc.
%\item {\tt mk\_strin} makes an input strucure containing various
%  parameters such as the source position and name, the LO\ frequency,
%  whether the noise diode was turned on, off, or was unchanged.
%\item {\tt set\_lhp} sets the frequency and level of the LO
%\item {\tt rxpwr} returns the channel-integrated spectral power from the
%  ROACH box as input.
%\item {\tt startchart1} runs a `chart recorder' using the
%  channel-integrated spectral power from the ROACH box as input. 
%\item {\tt leuschner\_rx} Take and record spectra with the ROACH box.
%\item {\tt filename} generate a filename of the form:
%  {\tt jjjjjjj.jjjjjj\_sn0000\_nd1\_1270123456}
%\item {\tt fits\_to\_sav} converts a fits file, which contains nrspectra
%  spectra, into a sav file with a single spectrum equal to the avg,
%  also the median. Also lots of ancillary info, all in a structure
%\item {\tt frq} calculate the array of IF or RF freqs from the tags in
%  the standard output structure.
%\end{enumerate}
%Normally, you will use only {\tt getspect} and {\tt mk\_strin} from the
%  above list.

%\subsection{Our Standard Output Structure}
%If you use our recommended commands for mapping, and in particular if
%you create the input structure {\tt strin} for {\tt getspec} (\S
%\ref{mappingcommands}), then you will use {\tt fits\_to\_sav} to write
%your datafiles. It saves your data in the following structure:
%\begin{verbatim}
%   SRCNR           INT           9999           you choose the source number
%   SRCNAME         STRING    '-9999'            you choose the source name
%   JD              DOUBLE           2457483.5   Julian day
%   RA              FLOAT          0.430058      RA
%   DEC             FLOAT           62.7256      Dec
%   SPCT_AVG        FLOAT     Array[8192, 4]     Average spectrum
%   PWR_AVG         FLOAT     Array[4]           chnl-avg of spct_avg
%   SPCT_MED        FLOAT     Array[8192, 4]     median spectrum
%   PWR_MED         FLOAT     Array[4]           chnl-avg of spct_med
%   NRSPECTRA       LONG               100       nrspectra in avg/med
%   FREQ_IF_CHNL0   DOUBLE       1.4400000e+08   IF freq chnl 0
%   FREQ_IF_CHNL8191
%                   DOUBLE       1.5599854e+08   IF freq chnl 8191
%   FREQ_RF_CHNL0   DOUBLE       1.4144000e+09   RF freq chnl 0
%   FREQ_RF_CHNL8191
%                   DOUBLE       1.4263985e+09   RF freq chnl 8191
%   LO1             DOUBLE       1.2704000e+09   LO freq
%   SB              DOUBLE           1.0000000   sideband
%   ND              INT              0           noise diode on/off
%   UGDOPP          FLOAT     Array[4]           ugdoppler output
%   PANGLE          DOUBLE           97.123027   parallactic angle
%   LST             DOUBLE           4.3368460   LST
%   AZ              DOUBLE           324.82700   Az
%   ALT             DOUBLE           47.232719   Alt
%   GL              DOUBLE           120.00000   Galactic longitude
%   GB              DOUBLE       5.9575176e-05   Galactic latitude
%   FREQARR         STRING    '=  fst.freq_if_chnl0 + (dindgen(8192)*'...
%\end{verbatim}
 
\section{Mapping: How to Spatially Sample} \label{sampling} 

\noindent
All of the HI projects examine the angular dependence of the 21-cm line
profile, so you need closely spaced observations to make a map or an
image. How closely should the observations be spaced?  The usual
criterion is two samples per FWHM (Full Width, Half Max) of the beam, because
observing at more closely spaced angles just gives redundant information
and takes extra time, while more widely spaced angles loses small-scale
structural information. (This is a re-statement of the Nyquist criterion for sampling
sky structure versus angle).  The FWHM is
almost $4^\circ$; so a spacing of $2^\circ$ is about right.

For the mapping projects (not the great-circle ones), we need to cover
areas of 1000 to 2000 square degrees. Consider the Orion-Eridanus
Superbubble (\S \ref{eridanus} below), which aims to map a region
covering roughly $(\ell=160^\circ \rightarrow 220^\circ, b=-70^\circ
\rightarrow -10^\circ)$. Suppose you set up a regular grid in
$(\ell,b)$ with $(\Delta \ell, \Delta b)$ both equal to
$2^\circ$. That's fine for $\Delta b$, but you'd be sampling too closely
in $\ell$ because the true (great-circle) angular distance
between two points is $\Delta \ell \cdot \cos(b)$; there's a
foreshortening for $b \neq 0^\circ$ (e.g.: when you're at the Earth's
North Pole, you can go completely around a small circle of constant $b$
with just a few steps.). So you can save lots of observing time by
observing at $\Delta \ell = {2^\circ \over \cos(b)}$ instead of $\Delta
\ell = 2^\circ$.

The true angular area is not the total extent in $\ell$ times the total
extent in $b$ because of the foreshortening discussed in the above
paragraph. So the actual angular area of the Orion-Eridanus map
isn't the range in $\ell$ times the range in $b$, i.e.\ $60^\circ
\times 60^\circ = 3600$ square degrees (which would require 900
pointings), but rather only about 2800 square degrees.  At $2^\circ$
sampling, that's about 700 pointings.

These projects require a lot of pointings,
but fortunately, the telescope is automated. With a
computer-controlled telescope you can do these observations in one
or two days, but that requires planning and coordination with other
groups.

\subsection{Observing Procedure} \label{mappingcommands}

\noindent
For taking the data at a particular position, we recommend thinking
through the procedure for each pointing:
\begin{enumerate}

\item Select the (ra, dec) of your position. You can use {\tt astropy} if you wish.

\item Decide the number of 0.7-sec spectra to obtain.

\item Compare the length of your observation to the crossing-time of your
beam to decide if you need to track your (ra, dec) position, or if you can
simply choose the (az, alt) corresponding to the temporal midpoint of
your observation and leave the pointing there.

\item Plan how often to take calibration data (with the noise diode on) and
any LO frequency shifts you want to use to separate the astrophysical
signal from the instrumental response.

\item Choose a {\tt filename = jjjjjjj.jjjjjj\_pt0000\_nd1.fits} or something
similar that encodes enough useful information (JD, pointing, LO, noise diode,
etc.) that you can find what you need after making many observations.

\item Use {\tt telescope.point(alt,az)} to point (and track, if necessary).

\item Use spectrometer.read\_spec(filename, Nspectra, (ra,dec), 'eq') to take and record data for each pointing/observing mode.

\end{enumerate}

\noindent You are advised to look at the documentation of these procedures before using them.

\subsection{Beware Operating near Azimuth 0/360}

\noindent
If the azimuth of the current position is $6^\circ$ and of the next one
is $354^\circ$, the telescope has to rotate nearly $360^\circ$ in azimuth,
which takes a long time. You don't want to make this transition more
than once (or at all, if you can manage it). Note: the telescope will
reliably point in the $370^\circ$-wide azimuth range $-5^\circ$ to
$365^\circ$---but not outside this range.

\subsection{Beware Operating Above Altitude 85 and Below/Near 14}

\noindent
The telescope cannot point above altitude $85^\circ$ or 
below $14^\circ$. When you are at low altitude, you might be
seeing the ground.

\section{Project: The Galactic Plane \boldmath{$(b=0^\circ)$}} 
\label{galacticplane}

\noindent
	Point the telescope at a series of Galactic longitudes ($\ell$)
along the Galactic plane (Galactic latitude $b = 0^\circ$), over the
full longitude range that is observable for our telescope.  Getting nice
results requires data over the largest section of the Galactic plane you
can get, which is roughly (or somewhat less than) $\sim -10^\circ \simlt
\ell \simlt 250^\circ$. This observation has two science goals:
\begin{enumerate}

	\item {\it The Galactic rotation curve}. Determine the rotation
curve of the Galaxy for the portion of the Galaxy inside the Sun and use
the result to estimate the {\it gravitational} mass $M_{grav}$ of the
Galaxy that lies inside the Solar circle; for this, you just assume the
usual $v^2 = {G M_{grav} \over R}$.  In fact, you can even get the
radial dependence $M_{grav}(R)$. Also, use your observations to estimate
the {\it gaseous} mass $M_{gas}(R)$ of the Galaxy.  What fraction of the
total Galactic mass comes from interstellar gas? For this you'll need to
know the radius of the Solar circle: it's 8.5 kpc.  See {\it Commentary}
below for a discussion. 

\item {\it The Galactic center.} Our Galactic center, like others, has a
  big black hole, with infalling matter and jets and lots of anomalous
  velocities. You can see a lot of this activity in  your map. Using the
  spatial extents and the velocities, you can estimate a black hole
  mass. To get an accurate estimate, you need to look at motions of
  matter lying really close to the black hole, which you can't do
  because you don't have the angular resolution. But you can at least
  make an estimate.

	\item {\it Spiral Structure of the Galaxy}. All your life,
you've been told that we live in a spiral galaxy.  Are they lying? In
principle, to detect spiral structure you make a position-velocity plot
along the Galactic plane [that's the image $T_A(\ell,V_{LSR})$ for
$b=0^\circ$].  Bright regions are regions of excess density---or regions in
which lots of HI is packed into a narrow velocity range (see \S
\ref{coldensity} below). 

	Do you see spirals in your position-velocity plot? How do you
tell? There's only one easy way.  Make a model of a spiral arm and see
how it projects onto position-velocity space.  To do this, you need to
know the rotation curve.  You've measured it for the inner Galaxy; for
the outer Galaxy (outside the Solar circle) assume that the rotation
curve is constant beyond the solar circle [$V(R)$=220 km/s for $R > 8.5$
kpc].  In polar coordinates, the equation for a spiral arm is

\begin{equation}
R_{arm}  =  R_0 e^ {\kappa (\phi - \phi_0)} 
\end{equation}

\noindent where $R_0$, $\kappa$, and $\phi_0$ are free parameters;
$\kappa$ is the tangent of the {\it pitch angle}.  You project this into
position-velocity space using equation \ref{vdopp} and your knowledge of
the Galactic geometry.  

{\it Comment:} Finding spiral arms inside the Solar circle is very
difficult, and has thwarted efforts by astronomers over the past several
decades. Finding them in the outer Galaxy is not as difficult.

\end{enumerate}

\section{Project: Is the Galactic Plane Flat?}

\noindent
External galaxies are often distorted (like the brim of a Fedora). 
These distortions are probably produced primarily by nearby neighbors. 
How about our own Galaxy? To determine this we want to look at the
vertical structure of the Galactic plane and see where the peaks occur;
a flat Galaxy would everywhere have the peaks at $b=0^\circ$. 

The most comprehensive way to observe and display these distortions is
with a map that covers the biggest possible swath in Galactic longitude
$\ell$ for the range of Galactic latitude ($b$) from $-20^\circ$ to
$+20^\circ$. This is a huge area---almost $10^4$ square degrees. At
$2^\circ$ sampling, you'd need $\sim 2500$ profiles.  To make the
project more manageable, you can increase the increment in $\ell$, say
to 4 degrees, while keeping the same, fully-sampled increment in
$b$. Resolution is $l$ is less important because---like a
fedora---the warp doesn't change rapidly with $l$.

This project affords a great opportunity to make a spectacular color
image in $(\ell,b)$ coordinates: brightness showing the amount of gas,
color the Galactic rotation.  Officially, the science goals here are to
estimate the thicknesses of the Galactic disk and, also, to obtain an
approximate Fourier representation of the warp---which is not so
straightforward given the absence of data in the ``Southern'' Galaxy.

\section{Project: The Galactic Poles---Great Circles at Constant Longitude $\ell$}
\label{galacticpoles}

\noindent
How is the interstellar gas distributed within the Galaxy---for example,
is it ``disk-like'' or more spherically distributed? Are there any
systematic motions other than just ``Galactic rotation''? (You'd be
surprised).  To answer these questions, determine the column density
and mean velocity of interstellar gas as a function of Galactic latitude
$b$. 

	To answer this completely you'd need to do an all-sky survey. That's
a big job.  Let's do something easier. We have one project (\S
\ref{galacticplane}) that looks around a great circle, the Galactic
equator (constant $b$). Other projects could check out one or more
orthogonal great circles (at constant longitudes $\ell$) going from one
Galactic pole to the other and back again (or, if not the whole 360
degree circle, as much as possible).  Particularly appropriate sets of
constant-longitude great circles are the pairs $\ell = (220^\circ,
40^\circ)$ (partly because you can get the whole great circle) and $\ell
= (130^\circ, 310^\circ)$ (because at positive latitudes there's weak
high-velocity gas).

	The science goals here are to characterize the thickness of the
gas layer and to determine the vertical kinematics of the gas, and if
possible an estimate of the energy involved in the vertical motions.

\section{Project: Mapping the North Celestial Pole} \label{celestial}

\noindent
The region near the North Celestial pole contains a large shell,
probably produced by one or more supernovae, and also to has angular
scales that are well-matched to our telescope and the available time for
your project. For this, you'd map the region covering roughly
$(\ell=105^\circ \ {\rm to} \ 160^\circ), (b=15^\circ \ {\rm to}
\ 50^\circ)$. Interesting features should produce antenna temperatures
$\sim 10$ K. This is about 1600 square degrees and, with 2 degree
spacing, requires about 400 profiles. With our telescope, this is
probably the most spectacular and contrasty object we can map in the
sky.

\section{Project: Mapping the Orion-Eridanus Superbubble} \label{eridanus}

\noindent
The ``Orion-Eridanus Superbubble'' was, and continues to be, produced by
energetic stellar winds and supernovae that were located in immediate
vicinity of the Orion nebula. For this, you'd map the region covering
roughly $(\ell=160^\circ \rightarrow 220^\circ, b=-70^\circ \rightarrow
-10^\circ)$. Interesting features should produce antenna temperatures
$\sim 20$ K. This is almost 2800 square degrees and, with 2 degree
spacing, requires almost 700 profiles. See \S \ref{sampling}.

The goal here is to map the HI in the 3-d space of $(l, b, v)$ (that's
Galactic longitude, latitude, and velocity) and then present the results
in one or more color images to show the hollowed-out shell with the
swept-up gas piled up at the edges.

\section{Project: Mapping the North Polar Spur's Expanding HI Shell}

\noindent
This is a huge shell produced (and continuing) by several energetic
stellar winds and supernovae that were located in the Sco/Oph
association of stars. The shell contains not only HI but also
relativistic electrons, so the shell is visible in both the 21-cm line
and synchrotron emission. We can't easily see the latter, but we can see
the HI---and the pattern of its velocity follows that of an expanding
shell.

For this, you'd map the region covering roughly $(\ell=210^\circ
\rightarrow 20^\circ, b=0^\circ \rightarrow 90^\circ)$. (The longitude
range is $170^\circ$: $210^\circ \rightarrow 360^\circ$ plus $0^\circ
\rightarrow 20^\circ$). This is roughly 1/4 of the whole sky, so this is
a huge area---almost 10000 square degrees. (This shell has an angular
diameter of $120^\circ$). But (unfortunately) you can't measure the
equivalent 2000 HI profiles because most of this area is too far
south. On the plus side, this makes the project do-able. In doing your
observations, you need to cover as far south as you possibly can. See
\S \ref{sampling}.

The goal here is to map the HI in the 3-d space of ${l, b, v}$ (that's
Galactic longitude, latitude, and velocity) and then present the results
in one or more color images to show the hollowed-out shell with the
expanding swept-up gas piled up at the edges.

\section{Project: Mapping a Big High-Velocity Cloud}

\noindent
When we look up, away from the Galactic plane, we see infalling
gas---some a very high velocities. It's called ``High-Velocity Gas''.
The line is weak (about 1 to 1.5 K), so you need high sensitivity---you
need to use much longer integration times than for the above projects,
at least a few minutes per point.  This project needs to map the region
bounded roughly by $(\ell=60^\circ \rightarrow 180^\circ), b=20^\circ
\rightarrow 60^\circ)$. This is about 3700 square degrees and needs
about 900 profiles at $2^\circ$ spacing. See
\S \ref{sampling}.

The goal here is to map the HI in the 3-d space of ${l, b, v}$ (that's
Galactic longitude, latitude, and velocity) and then present the results
in one or more color images.

\section{Project: Mapping the Magellanic Stream}

\noindent
The Magellanic Stream is an intergalactic tidal stream produced by
gravitational interaction between the Magellanic Clouds and the Milky
Way. The signal is weak ($\sim$ a few tenths K), so you need to use much
longer integration times than for the above projects---a minimum of 10
minutes per point. You need to map the pie-shaped area bounded roughly
by $(\ell=60^\circ \rightarrow 110^\circ), b=-90^\circ \rightarrow
-30^\circ)$. This is about 1250 square degrees and needs about 310
profiles at $2^\circ$ spacing. See \S \ref{sampling}.  Also, the LSR
velocity of this gas ranges from roughly $-400 \ {\rm to} \ -100$ km/s
along its length, so you need frequency switch by a large enough
interval.

The goal here is to map the HI in the 3-d space of ${l, b, v}$ (that's
Galactic longitude, latitude, and velocity) and then present the results
in one or more color images.

\section{Basics of the 21-CM Line} \label{basics}

\noindent
	The 21-cm line, with frequency 1420.405751786 MHz, comes from
atomic hydrogen (HI).  In the terrestrial environment, H atoms quickly
become H$_2$ molecules; in interstellar space, where densities are far
lower than in the best vacuum systems on Earth and there are ``lots'' of
UV photons that dissociate H$_2$, H remains atomic unless it resides
inside dark clouds where it is shielded from starlight.

\subsection{Column Density and Mass} \label{coldensity}

\noindent
	The intensity of the 21-cm line is directly proportional to the
column density of H atoms as long as the opacity of the line is small;
this is a reasonably good approximation (but not perfect, particularly
in the Galactic plane where the line is strong). With this
approximation, 

\begin{equation} \label{nh1}
N_{HI} = 1.8 \times 10^{18} \int T_{B}(v) dv \ {\rm cm^{-2}}. 
\end{equation}

\noindent Here $N_{HI}$ is the column density of H atoms---the number of
atoms in a 1 cm$^2$ column along the line of sight; $T_{B}(v)$ is the
brightness temperature of the 21-cm line, which is a function of 
velocity $v$; and $v$ is the velocity in km s$^{-1}$. The velocity $v$
is produced by the Doppler effect, so a frequency shift $\Delta \nu$
from line center corresponds to velocity $v = - c {\Delta \nu \over
\nu}$ or, for the 21-cm line, $v = -{\Delta \nu \over 4.73 {\rm kHz}}$ km/s.
Note the minus sign. It means that positive velocities are receding---a
very convenient convention for astronomy, because of the expansion of
the Universe. 

          Note an important corollary to equation \ref{nh1}: If we
consider a small velocity interval $\Delta v$, then the number of H
atoms in the column in that velocity range is just 

\begin{equation} \label{nh2}
N_{HI}(v \rightarrow v + \Delta v) = 1.8 \times 10^{18} T_{B}(v) \Delta
v \ {\rm cm^{-2}} \ .  
\end{equation}

\noindent This is very important, because it gives us the opportunity to
make maps of the interstellar gas at different velocities and to
determine how it moves.

	To get the column density we need to get the brightness
temperature $T_B$, which is not the same as our antenna temperature
$T_A$. The relationship between these depends on the relative size of
the source and the beam. This is equation (9) in the ``Fount of All
Knowledge!'' handout, namely 

\begin{equation} \label{taeqn}
T_A \approx T_B {\Omega_s \over \Omega_s + \Omega_b} \ ,
\end{equation}

\noindent where $\Omega_s$ and $\Omega_b$ are the solid angles of the
source and beam, respectively. From this, we see that if the source
fills the beam ($\Omega_s \gtrsim \Omega_b$) then $T_A \approx \langle
T_B\rangle$ (the brackets denote the average over solid angle);
while if it is much smaller ($\Omega_s \ll \Omega_b$) then $T_A \approx
{\langle T_B \Omega_s\rangle \over \Omega_b}$, i.e.\ $T_A$ is smaller by the ratio of
the solid angles. 

	To get the mass of HI from the column density, you need to know
the area of the region in {\it linear} measure, which is just $\Omega \
d^2$, where $d$ is the distance.  Each HI atom has mass $m_H$, so the
total mass of HI in a region of size $\Omega$ is just

\begin{mathletters} \label{masseqn}
\begin{equation} 
M_{HI} = m_H \ d^2 \ \langle N_{HI} \Omega\rangle \ .
\end{equation}

\noindent Here $\langle N_{HI} \Omega \rangle$ is shorthand for the
general relation, which uses an integral:

\begin{equation}
\langle N_{HI} \Omega \rangle = \int_{\rm region} N_{HI} d \Omega
\end{equation}
\end{mathletters}

\noindent Substituting for $N_{HI}$ from equation \ref{nh2}, we have

\begin{equation}  \label{telemass}
M_{HI}(v) = 1.8 \times 10^{18} \Delta v \ d^2 \  m_H \ \langle T_B  \Omega\rangle \ {\rm
gm} \ . 
\end{equation}

\noindent Units are cgs. Sometimes there is a well-defined source with
boundaries; in this case, to get the mass of the whole source, we use
the solid angle occupied by the source, $\Omega_s$.

	Sometimes (in fact, often) we want to know the mass seen {\it by
the telescope} for some particular observation.  For an extended region
with $\Omega \gg \Omega_b$, $T_A = T_B$ and the telescope sees the solid
angle $\Omega_b$, so the product $\langle T_B \Omega\rangle = T_A
\Omega_b$ because angular area seen by the telescope is limited by its
beam size.  In contrast, if the HI emission is limited to a small
region---a small source with $\Omega_s \ll \Omega_b$---then $T_A \approx
{\langle T_B \Omega_b\rangle \over \Omega_s}$ so the product $\langle
T_B \Omega_s\rangle = T_A \Omega_b$; the telescope sees the whole
source.  

For both extremes, the product $T_B \Omega = T_A \Omega_b$. 
It's not only these two extremes, but for {\it all} sources the
product $\langle T_B \Omega \rangle= T_A \Omega_b$.  Thus, it is always true that the
mass seen by the telescope is

\begin{equation}  \label{telemass1}
M_{HI}(v) = 1.8 \times 10^{18} \Delta v \ d^2 \ m_H \ T_A  \Omega_b  \ {\rm
gm} \ . 
\end{equation}

\noindent The distance $d$ is usually a function of velocity $v$,
especially in the Galactic plane. 

	$T_A(v)$ is directly measured and $\Omega_b$ is the telescope
beam area, which is known, so it's easy to calculate $M_{HI}(v)$---but
only if you know the distance. Often you don't know the distance, but
you might have a hunch for a reasonable value for the distance. Suppose
this is 100 parsecs. In this case, people usually evaluate the mass for
this distance and, when giving the mass, say ``The mass is $xxx \times
d_{100}^2$, where $d_{100}$ is the distance in units of 100 pc''.

\subsection{Converting Galactic Rotation to Doppler Velocity}

\noindent
          Measurement of the Doppler shift caused by differential
Galactic rotation for $0^\circ < \ell < 90^\circ$ allows a direct
determination of the Galactic rotation curve inside the Solar circle,
using the ``tangent point'' method. See Burton's article ``Structure
of our Galaxy from Observations of HI'' in {\it Galactic and
Extragalactic Radio Astronomy, second edition} (editors: G.L. Verschuur
and K.I. Kellermann). In essence, you use the following equation.

	We won't go through the derivation here; we cover it in class,
and it is also done in Burton's article,
page 303-304.  Let $V_{Dopp}$ be the Doppler velocity (this is also the
observed LSR velocity), $V(R)$ be the Galactic rotation velocity at
Galactocentric distance $R$, and let the subscript $\odot$ denote values
at the Solar circle.  Then we have
\begin{equation} \label{vdopp}
V_{Dopp} = \left[ {V(R) \over R} - {V(R_\odot) \over R_\odot}\right]
R_\odot \sin(\ell)
\end{equation}
\noindent The values at the solar circle are $V(R_\odot) \approx 220$
km/s, $R_\odot \approx 8.5$ kpc.

\section{Displaying Your Data} \label{datadisplay}

\noindent
Before actually working with images on the computer, you may need to
familiarize yourself with our imaging handouts:
\begin{enumerate}

\item MAP PROJECTIONS: REPRESENTING A SPHERICAL SURFACE ON A COMPUTER
  SCREEN.

\item {\tt jupyter\_tutorials/lab4} has examples of making images, colorbars, and map projections.
\end{enumerate}

\subsection{Map Projections: Representing a Spherical Surface}

\noindent
Computer screens consist of an array of dots that can glow in various
colors. The dots are arranged in a square array and are called {\it
  pixels}. Images are the same, with the added feature that
the pixels need not be square; that is, then horizontal distance can
differ from the vertical one. To display our data as an image on the
screen, we must populate these pixels with observed data. 

Our observed positions do not lie on this grid. Rather, our observations
lie on the celestial sphere. We need to represent this spherical surface
on our 2d pixellated computer screen---or as a 2d image on
a flat piece of paper. There are innumerable ways to do this
{\it projection}, each of which has its own
desirable properties. No projection is perfect; each is a compromise 
among various desirable and undesirable properties. 

Our handout MAP PROJECTIONS describes the most common projections. Two
examples:
\begin{enumerate}

\item The simplest is the {\it cylindrical
equidistant projection}, for which the entire sky is represented by
longitude horizontally and latitude vertically with square pixels each
having the same size in $(\Delta \ell, \Delta b)$. Near the equator this
is a very nice projection because it has many desirable qualities: it
is nearly conformal, the pixels are nearly of equal solid angle. But as
you move away from the equator, these properties decay with increasing
severity because of foreshortening.

\item Suppose we want to be as conformal as possible, particularly with
  respect to representing small circles (supernova remnants or
  supershell walls). This is the {\it stereographic projection}, which
  is centered on its own defined pole and for which the conversion
  between its $(long, lat)$ and the pixel values $(x,y)$ is
%
\begin {mathletters}
\begin{equation}
   R = \tan[ 0.5 \times (90.-lat)] 
\end{equation}
\begin{equation}
   x= R \; \cos(long) 
\end{equation}
\begin{equation}
   y= R \; \sin(long) 
\end{equation}
\end {mathletters}
%
% XXX Basemap?
You can use the procedures we developed to create a stereographic or
gnomic projection; see our `How to create a perspective projection'
on the web page. It tells how to define a 
new coordinate system by specifying the pole of the projection, which ideally
is near the center of the supershell being mapped, how to convert
$(ra,dec)$ or $(\ell,b)$ to the $(long,lat)$ of that new system, and how
to populate the projection map plane.

\end{enumerate}

\subsection{Regridding}

\noindent
How do we populate this $(x,y)$ grid
with our data? This process is called {\it regridding}. There are
several ways to regrid; we describe the one that loses least
information (but requires the most computer resources---our
philosophy is `computers are cheap').

To regrid proceed as
follows: \begin{enumerate}

\item Set the angular $(x,y)$ pixel size. The size must be smaller than
  the smallest great-circle distance between observed points. For
  example, if the separation between observed points is 2 degrees, a
  pixel size of 1 degree (or 0.1 degree) is OK. For the cylindrical
  equidistant projection with a pixel size of 1 degree there are 360
  horizontal pixels and 180 vertical ones, for a total of 64800 pixels.

\item Create an empty 3-d data cube of the appropriate dimensions. The
  first two dimensions are $(x,y)$ and the third is velocity. If you
  have 256 velocity channels, the above cylindrical equidistant cube
  would have dimensions $360 \times 180 \times 256$. The cells in this
  cube are 3-d and are called {\it voxels}.

\item For each pixel, find the nearest observed position. For the angles
  on the sky, a suitable approximation for the distance squared is $[
    (\cos (b) \Delta \ell)^2 + \Delta b^2]$. Populate that pixel with
  the nearest observed data value. For the velocity, use linear
  interpolation.  ({\tt scipy.interpolate} has many convenient options for
  this purpose).

\end{enumerate}

\subsection{Displaying Your Data---The Exploratory Phase}

\noindent
For public presentation, you may want to display your data cube in its
full 3d glory with a 2d image where brightness represents `amount'
(e.g., the integrated area of the HI line) and color the mean
velocity. Or by describing each pixel by 3 numbers (e.g., the integrated
intensity within 3 different velocity ranges) and writing them on the
same image plane as the 3 independent colors red, green, blue.

However, making effective use of color requires defining what color
means.  Set up
an {\tt matplotlib} imaging window and look at successive $(x,y)$ scalar images at
different velocities. That is, make a `movie'. For our above example
$360 \times 180 \times 256$ data cube, a quick and dirty way
is: 

\begin{verbatim}
plt.ion() # makes pylab interactive, so you can replot data in the same figure
fig = plt.imshow(data[...,0], vmax=max, vmin=min, cmap=cmap)
plt.draw() # not necessary if run within IPython
for i in xrange(1, data.shape[-1]):
    time.sleep(1) # change data every 1 second
    fig.set_data(data[...i])
    plt.draw()
\end{verbatim}

Here, colors are chosen from the {\tt cmap} (there are bazillions of options).
The keywords {\tt (min, max)} mean a data value of {\tt
  min} gives the minimum color and {\tt max} gives the maximum.

\end{document}

